name: Generate Blog Post

on:
  workflow_dispatch:
    inputs:
      topic:
        description: 'Blog topic'
        required: true
        type: string
      product:
        description: 'Product name'
        required: true
        type: string
      platform:
        description: 'Platform (e.g., aspose)'
        required: true
        type: string
        default: 'aspose'
      keyword_source:
        description: 'Keyword source (e.g., manual, auto)'
        required: true
        type: string
        default: 'manual'

jobs:
  generate:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'

    - name: Cache pip packages
      uses: actions/cache@v4
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-

    - name: Prepare keywords file
      run: |
        cp output/kra/samples/keywords.xlsx output/kra/keywords.xlsx

    - name: Remove any .env files that could interfere
      run: |
        find . -name ".env" -type f -delete
        echo "Removed all .env files"

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip

        cd agent_engine
        pip install -r requirements.txt
        cd ..

        cd mcp-servers
        pip install -r requirements.txt
        cd ..

    - name: Create runtime .env file with secrets
      run: |
        cd agent_engine
        cat > .env << EOF
        OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }}
        ASPOSE_LLM_API_KEY=${{ secrets.ASPOSE_LLM_API_KEY }}
        ASPOSE_LLM_BASE_URL=${{ secrets.ASPOSE_LLM_BASE_URL }}
        ASPOSE_LLM_MODEL=${{ secrets.ASPOSE_LLM_MODEL }}
        SERPAPI_API_KEY=${{ secrets.SERPAPI_API_KEY }}
        EOF
        echo ".env file created"

    - name: Verify .env file (without exposing secrets)
      run: |
        cd agent_engine
        echo "Checking .env file exists:"
        ls -la .env
        echo "Number of lines in .env:"
        wc -l .env

    - name: Generate Blog
      run: |
        cd agent_engine
        python main.py --topic "${{ inputs.topic }}" --product "${{ inputs.product }}" --platform "${{ inputs.platform }}" --keyword_source "${{ inputs.keyword_source }}"

    - name: Prepare blogs-to-push folder
      run: |
        mkdir -p blogs-to-push
        cp -r mcp-servers/output/blogs/*.md blogs-to-push/ 2>/dev/null || echo "⚠ No generated blogs found in mcp-servers/output/blogs/"

    - name: Upload Generated Blog as Artifact
      uses: actions/upload-artifact@v4
      with:
        name: generated-blog-${{ github.run_number }}
        path: blogs-to-push/*.md
        if-no-files-found: warn

    ####################################################################
    # Push generated blog to ganji repo
    ####################################################################
    - name: Push generated blog to ganji repo
      if: success()
      run: |
        git config --global user.email "action@github.com"
        git config --global user.name "GitHub Action"

        if [ -z "${{ secrets.GANJI_REPO_PAT }}" ]; then
          echo "❌ GANJI_REPO_PAT is EMPTY! Fix your repo secret."
          exit 1
        fi

        echo "Cloning ganji repo..."
        git clone https://x-access-token:${{ secrets.GANJI_REPO_PAT }}@github.com/mustafabutt/ganji.git ganji || {
          echo "❌ Failed to clone repo — invalid PAT or wrong GitHub account."
          exit 1
        }

        echo "Copying generated blog files from blogs-to-push/"
        cp blogs-to-push/*.md ganji/ 2>/dev/null || {
          echo "❌ No MD files found in blogs-to-push/"
          exit 1
        }

        cd ganji
        git add .
        git commit -m "Add generated blog: ${{ inputs.topic }} (Run ${{ github.run_number }})" || echo "⚠ Nothing to commit"
        git push || {
          echo "❌ Authentication failed when pushing — invalid PAT or insufficient permissions."
          exit 1
        }
