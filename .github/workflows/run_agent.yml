name: Generate Blog Post

on:
  workflow_dispatch:
    inputs:
      topic:
        description: 'Blog topic'
        required: true
        type: string
      product:
        description: 'Product name'
        required: true
        type: string
      platform:
        description: 'Platform (e.g., aspose)'
        required: true
        type: string
        default: 'aspose'
      keyword_source:
        description: 'Keyword source (e.g., manual, auto)'
        required: true
        type: string
        default: 'manual'

jobs:
  generate:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'

    - name: Cache pip packages
      uses: actions/cache@v4
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-

    - name: Prepare keywords file
      run: |
        cp output/kra/samples/keywords.xlsx output/kra/keywords.xlsx

    - name: Remove any .env files that could interfere
      run: |
        find . -name ".env" -type f -delete
        echo "Removed all .env files"

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        cd agent_engine
        pip install -r requirements.txt
        cd ..
        cd mcp-servers
        pip install -r requirements.txt
        cd ..

    - name: Create runtime .env file with secrets
      run: |
        cd agent_engine
        cat > .env << EOF
        OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }}
        ASPOSE_LLM_API_KEY=${{ secrets.ASPOSE_LLM_API_KEY }}
        ASPOSE_LLM_BASE_URL=${{ secrets.ASPOSE_LLM_BASE_URL }}
        ASPOSE_LLM_MODEL=${{ secrets.ASPOSE_LLM_MODEL }}
        SERPAPI_API_KEY=${{ secrets.SERPAPI_API_KEY }}
        EOF
        echo ".env file created"

    - name: Generate Blog
      run: |
        cd agent_engine
        python main.py --topic "${{ inputs.topic }}" --product "${{ inputs.product }}" --platform "${{ inputs.platform }}" --keyword_source "${{ inputs.keyword_source }}"

    - name: Collect generated blogs with folder structure
      run: |
        mkdir -p staging_blogs
        
        # Find MD files created in the last 10 minutes
        echo "=== Finding recently generated MD files ==="
        find . -name "*.md" -type f -mmin -10 | while read mdfile; do
          echo "Found: $mdfile"
          
          # Get the directory containing the MD file
          md_dir=$(dirname "$mdfile")
          md_basename=$(basename "$mdfile")
          
          # Create the same directory structure in staging
          target_dir="staging_blogs/$(basename "$md_dir")"
          mkdir -p "$target_dir"
          
          # Copy the entire directory (including any associated files/folders)
          cp -r "$md_dir"/* "$target_dir/" 2>/dev/null || true
          
          echo "Copied $md_dir to $target_dir"
        done
        
        echo ""
        echo "=== Staging directory structure ==="
        tree staging_blogs/ 2>/dev/null || find staging_blogs/ -type f
        
        # Check if we have any files
        if [ -z "$(ls -A staging_blogs/)" ]; then
          echo "❌ No blog files were generated!"
          exit 1
        fi

    - name: Upload Generated Blog as Artifact
      uses: actions/upload-artifact@v4
      with:
        name: generated-blog-${{ github.run_number }}
        path: staging_blogs/
        if-no-files-found: error

    ####################################################################
    # Push generated blog to ganji repo
    ####################################################################
    - name: Push generated blog to ganji repo
      if: success()
      run: |
        git config --global user.email "action@github.com"
        git config --global user.name "GitHub Action"

        if [ -z "${{ secrets.GANJI_REPO_PAT }}" ]; then
          echo "❌ GANJI_REPO_PAT is EMPTY! Fix your repo secret."
          exit 1
        fi

        echo "Cloning ganji repo..."
        git clone https://x-access-token:${{ secrets.GANJI_REPO_PAT }}@github.com/mustafabutt/ganji.git ganji || {
          echo "❌ Failed to clone repo — invalid PAT or wrong GitHub account."
          exit 1
        }

        echo "Copying generated blog folders (excluding README and existing files)..."
        
        # Copy only the newly generated content from staging_blogs
        cp -r staging_blogs/* ganji/ || {
          echo "❌ Failed to copy files from staging_blogs/"
          exit 1
        }

        cd ganji
        
        # Only add the new files/folders (not README.md or other existing files)
        git add staging_blogs/* 2>/dev/null || git add . --ignore-errors
        
        # Check what's being committed
        echo "=== Files to be committed ==="
        git status --short
        
        # Commit only if there are changes
        if git diff --staged --quiet; then
          echo "⚠️ No new files to commit"
        else
          git commit -m "Add generated blog: ${{ inputs.topic }} (Run ${{ github.run_number }})"
          git push || {
            echo "❌ Authentication failed when pushing — invalid PAT or insufficient permissions."
            exit 1
          }
          echo "✅ Successfully pushed blog to ganji repo"
        fi