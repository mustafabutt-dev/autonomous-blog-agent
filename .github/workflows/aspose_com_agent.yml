name: Generate Blog Post for aspose.com

on:
  workflow_dispatch:
    inputs:
      topic:
        description: 'Blog topic'
        required: true
        type: string
      
      product:
        description: 'Product name'
        required: true
        type: choice
        default: 'Aspose.Slides'
        options:
          - 'Aspose.Slides'
          - 'Aspose.Words'
          - 'Aspose.PSD'
          - 'Aspose.Imaging'
          - 'Aspose.3D'
          - 'Aspose.Page'
          - 'Aspose.TeX'
          - 'Aspose.GIS'
          - 'Aspose.OMR'
          - 'Aspose.HTML'
          - 'Aspose.ZIP'
          - 'Aspose.CAD'
          - 'Aspose.Email'
          - 'Aspose.BarCode'
      
      platform:
        description: 'Platform'
        required: true
        type: choice
        options:
          - 'Java'
          - '.NET'
          - 'C++'
          - 'PHP'
          - 'SharePoint'
          - 'JasperReports'
          - 'Reporting Services'
          - 'JavaScript via C++'
          - 'Go via C++'
          - 'Rust via C++'
          - 'Node.js via C++'
          - 'Node.js via Java'
          - 'Node.js via .NET'
          - 'PHP via Java'
          - 'Python via .NET'
          - 'Python via Java'
          - 'Android via Java'
        default: 'Java'
      
      keyword_source:
        description: 'Keyword source'
        required: true
        type: choice
        options:
          - 'auto (using SerpApi)'
          - 'manual (using Google Keyword Planner Sheet)'
        default: 'auto (using SerpApi)'

jobs:
  generate:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'

    - name: Cache pip packages
      uses: actions/cache@v4
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-

    - name: Prepare keywords file
      run: |
        # Create the target directory structure
        mkdir -p /home/runner/work/autonomous-blog-agent/output/kra/samples
        
        # Copy the keywords file to the expected location
        cp output/kra/samples/keywords.xlsx /home/runner/work/autonomous-blog-agent/output/kra/samples/keywords.xlsx
        
        # Verify the file exists
        ls -la /home/runner/work/autonomous-blog-agent/output/kra/samples/keywords.xlsx
        
        echo " Keywords file prepared successfully"

    - name: Remove any .env files that could interfere
      run: |
        find . -name ".env" -type f -delete
        echo "Removed all .env files"

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        cd agent_engine
        pip install -r requirements.txt
        cd ..
        cd mcp-servers
        pip install -r requirements.txt
        cd ..

    - name: Create runtime .env file with secrets
      run: |
        cd agent_engine
        cat > .env << EOF
        ASPOSE_LLM_API_KEY=${{ secrets.ASPOSE_LLM_API_KEY }}
        ASPOSE_LLM_BASE_URL=${{ secrets.ASPOSE_LLM_BASE_URL }}
        ASPOSE_LLM_MODEL=${{ secrets.ASPOSE_LLM_MODEL }}
        SERPAPI_API_KEY=${{ secrets.SERPAPI_API_KEY }}
        EOF
        echo ".env file created"

    - name: Generate Blog
      run: |
        cd agent_engine
        python main.py --topic "${{ inputs.topic }}" --product "${{ inputs.product }}" --platform "${{ inputs.platform }}" --keyword_source "${{ inputs.keyword_source }}" --brand "aspose.com"

    - name: Find generated blog folder
      id: find_blog
      run: |
        echo "=== Searching for generated blog folder ==="
        
        # Search for folders matching the pattern YYYY-MM-DD-*
        blog_folder=$(find . -type d -name "20??-??-??-*" -mmin -10 | head -1)
        
        if [ -z "$blog_folder" ]; then
          echo " No blog folder found with pattern YYYY-MM-DD-*"
          exit 1
        fi
        
        echo "Found blog folder: $blog_folder"
        blog_folder_name=$(basename "$blog_folder")
        echo "blog_folder_name=$blog_folder_name" >> $GITHUB_OUTPUT
        echo "blog_folder_path=$blog_folder" >> $GITHUB_OUTPUT
        
        # Verify index.md exists
        if [ ! -f "$blog_folder/index.md" ]; then
          echo " index.md not found in $blog_folder"
          exit 1
        fi
        
        echo "✅ Found: $blog_folder_name with index.md"
        ls -la "$blog_folder"

    - name: Extract product folder name
      id: product_folder
      run: |
        # Convert product name to lowercase and remove "Aspose." prefix
        # Example: "Aspose.Slides" -> "slides"
        product_folder=$(echo "${{ inputs.product }}" | sed 's/Aspose\.//g' | tr '[:upper:]' '[:lower:]')
        echo "product_folder=$product_folder" >> $GITHUB_OUTPUT
        echo " Product folder name: $product_folder"

    - name: Upload Generated Blog as Artifact
      uses: actions/upload-artifact@v4
      with:
        name: generated-blog-${{ github.run_number }}
        path: ${{ steps.find_blog.outputs.blog_folder_path }}
        if-no-files-found: error

    ####################################################################
    # Create Pull Request in ganji repo
    ####################################################################
    - name: Create Pull Request in ganji repo
      if: success()
      env:
        BLOG_FOLDER_NAME: ${{ steps.find_blog.outputs.blog_folder_name }}
        BLOG_FOLDER_PATH: ${{ steps.find_blog.outputs.blog_folder_path }}
        PRODUCT_FOLDER: ${{ steps.product_folder.outputs.product_folder }}
        GH_TOKEN: ${{ secrets.GANJI_REPO_PAT }}
      run: |
        git config --global user.email "action@github.com"
        git config --global user.name "GitHub Action"

        if [ -z "${{ secrets.GANJI_REPO_PAT }}" ]; then
          echo " GANJI_REPO_PAT is EMPTY! Fix your repo secret."
          exit 1
        fi

        echo "Cloning ganji repo..."
        git clone https://x-access-token:${{ secrets.GANJI_REPO_PAT }}@github.com/mustafabutt/ganji.git ganji || {
          echo " Failed to clone repo — invalid PAT or wrong GitHub account."
          exit 1
        }

        cd ganji
        
        # Create the target directory structure if it doesn't exist
        TARGET_DIR="content/Aspose.Blog/$PRODUCT_FOLDER"
        mkdir -p "$TARGET_DIR"
        echo " Target directory: $TARGET_DIR"
        
        # Create a new branch for this blog post
        BRANCH_NAME="blog/$PRODUCT_FOLDER/$BLOG_FOLDER_NAME"
        git checkout -b "$BRANCH_NAME"
        
        echo "Copying blog folder: $BLOG_FOLDER_NAME to $TARGET_DIR"
        
        # Copy the blog folder to the correct product directory
        cp -r "../$BLOG_FOLDER_PATH" "$TARGET_DIR/" || {
          echo " Failed to copy folder $BLOG_FOLDER_PATH"
          exit 1
        }
        
        # Add only the new blog folder
        git add "$TARGET_DIR/$BLOG_FOLDER_NAME"
        
        # Check what's being committed
        echo "=== Files to be committed ==="
        git status --short
        
        if git diff --staged --quiet; then
          echo " No new files to commit"
          exit 0
        fi
        
        # Commit the changes
        git commit -m "Add generated blog for ${{ inputs.product }}: ${{ inputs.topic }}"
        
        # Push the branch
        git push -u origin "$BRANCH_NAME" || {
          echo " Failed to push branch."
          exit 1
        }
        
        echo " Branch $BRANCH_NAME pushed successfully"
        
        # Create Pull Request using GitHub CLI
        gh pr create \
          --repo mustafabutt/ganji \
          --base main \
          --head "$BRANCH_NAME" \
          --title "[${{ inputs.product }}] ${{ inputs.topic }}" \
          --body "## Generated Blog Post

        **Product:** ${{ inputs.product }}
        **Topic:** ${{ inputs.topic }}
        **Platform:** ${{ inputs.platform }}
        **Keyword Source:** ${{ inputs.keyword_source }}
        **Target Path:** \`content/Aspose.Blog/$PRODUCT_FOLDER/$BLOG_FOLDER_NAME\`

        **Generated by:** GitHub Actions (Run #${{ github.run_number }})
        **Workflow:** ${{ github.workflow }}

        ---

        This pull request adds a new blog post generated by the autonomous blog agent.

        ### Contents:
        - Folder: \`$BLOG_FOLDER_NAME\`
        - File: \`index.md\`
        - Location: \`content/Aspose.Blog/$PRODUCT_FOLDER/\`

        Please review and merge if the content looks good!" || {
          echo " Failed to create pull request."
          exit 1
        }
        
        echo " Pull request created successfully!"